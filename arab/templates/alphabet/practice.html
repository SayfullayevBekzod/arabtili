{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gray-900 text-white relative overflow-hidden">
    <input type="hidden" id="letter-id" value="{{ letter.id }}">
    {% csrf_token %}

    <!-- Audio Source -->
    {% if letter.pronunciations.first.audio %}
    <audio id="audio-player" src="{{ letter.pronunciations.first.audio.url }}"></audio>
    {% endif %}

    <div class="w-full max-w-md p-6 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 relative z-10">

        <!-- Step 1: Intro (Tanishish) -->
        <div id="view-intro" class="text-center space-y-8">
            <h2 class="text-2xl font-bold text-cyan-400">1. Tanishish</h2>
            <div class="text-9xl font-mono text-cyan-500 animate-pulse">
                {{ letter.arabic }}
            </div>
            <p class="text-xl">{{ letter.name }}</p>
            <button id="btn-intro-next"
                class="w-full py-4 bg-cyan-600 hover:bg-cyan-500 rounded-xl text-xl font-bold transition">
                Boshlash <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>

        <!-- Step 2: Listen (Tinglash) -->
        <div id="view-listen" class="hidden text-center space-y-8">
            <h2 class="text-2xl font-bold text-purple-400">2. Tinglash</h2>
            <div class="p-10 bg-gray-700 rounded-full inline-block cursor-pointer hover:bg-gray-600 transition"
                id="btn-listen-play">
                <i class="fas fa-volume-up text-6xl text-purple-300"></i>
            </div>
            <p class="text-gray-400">Tovushni diqqat bilan tinglang</p>
            <button id="btn-listen-next"
                class="w-full py-4 bg-purple-600 hover:bg-purple-500 rounded-xl text-xl font-bold transition">
                Tushundim <i class="fas fa-check ml-2"></i>
            </button>
        </div>

        <script>
            // TTS Fallback for letter pronunciation
            (function () {
                const letterArabic = "{{ letter.arabic }}";
                const letterName = "{{ letter.name }}";
                const audioPlayer = document.getElementById('audio-player');
                const listenBtn = document.getElementById('btn-listen-play');

                function playLetterSound() {
                    // Try audio file first
                    if (audioPlayer && audioPlayer.src && !audioPlayer.src.endsWith('/')) {
                        audioPlayer.play().catch(() => useTTS());
                    } else {
                        useTTS();
                    }
                }

                function useTTS() {
                    // Web Speech API TTS - Arabic voice
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(letterArabic);
                        utterance.lang = 'ar-SA';
                        utterance.rate = 0.7;
                        utterance.pitch = 1;
                        speechSynthesis.speak(utterance);
                    } else {
                        alert('Brauzeringiz tovush sintezini qo\'llab-quvvatlamaydi.');
                    }
                }

                if (listenBtn) {
                    listenBtn.addEventListener('click', playLetterSound);
                }
            })();
        </script>

        <!-- Step 3: Select (Tanlash) -->
        <div id="view-select" class="hidden text-center space-y-8">
            <h2 class="text-2xl font-bold text-yellow-400">3. Tanlash</h2>
            <p class="text-lg">Qaysi biri "{{ letter.name }}"?</p>
            <div class="grid grid-cols-2 gap-4">
                {% for opt in options %}
                <div class="option-btn p-6 bg-gray-700 rounded-xl text-6xl cursor-pointer hover:bg-gray-600 transition flex items-center justify-center border-2 border-transparent hover:border-yellow-500"
                    data-correct="{% if opt.id == letter.id %}true{% else %}false{% endif %}">
                    {{ opt.arabic }}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Step 4: Write (Yozish) -->
        <div id="view-write" class="hidden text-center space-y-6">
            <h2 class="text-3xl font-black bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-teal-300">
                4. Yozish
            </h2>
            <p class="text-sm font-medium text-slate-400 uppercase tracking-widest">
                Harf ustidan barmoq bilan yuriting
            </p>

            <div
                class="relative w-72 h-72 mx-auto rounded-3xl bg-slate-900/50 border border-white/10 shadow-2xl backdrop-blur-sm flex items-center justify-center overflow-hidden group">
                <!-- Grid background for precision feel -->
                <div class="absolute inset-0 opacity-20"
                    style="background-image: linear-gradient(#ffffff 1px, transparent 1px), linear-gradient(90deg, #ffffff 1px, transparent 1px); background-size: 20px 20px; background-position: center;">
                </div>

                <svg viewBox="{{ letter.viewbox }}" class="relative z-10 w-full h-full p-6 overflow-visible">
                    <defs>
                        <marker id="arrow-guide" markerWidth="4" markerHeight="4" refX="2" refY="2" orient="auto">
                            <path d="M0,0 L4,2 L0,4 L1.5,2 z" fill="#94a3b8" />
                        </marker>
                    </defs>

                    <!-- LAYER 1: Main Letter (Real Calligraphic Font) -->
                    <!-- Used as the "under-layer" visual -->
                    <text x="50" y="75" text-anchor="middle" font-family="'Noto Naskh Arabic', serif" font-size="80"
                        fill="#e2e8f0" class="select-none pointer-events-none opacity-30 font-bold">
                        {{ letter.arabic }}
                    </text>

                    <!-- LAYER 2: Writing Guide (The Path Logic) -->
                    <path d="{{ letter.svg_path }}" stroke="#cbd5e1" stroke-width="2" stroke-dasharray="8, 6"
                        stroke-linecap="round" stroke-linejoin="round" fill="none" marker-end="url(#arrow-guide)"
                        class="opacity-60" />

                    <!-- LAYER 3: Active Fill Path (Progress) -->
                    <path id="letter-path" d="{{ letter.svg_path }}" stroke="#475569" stroke-width="16" fill="none"
                        stroke-linecap="round" stroke-linejoin="round" stroke-opacity="0.9"
                        style="stroke-dasharray: 1000; stroke-dashoffset: 1000;">
                    </path>

                    <!-- Handle -->
                    <circle id="drag-handle" cx="0" cy="0" r="12" fill="#7c3aed"
                        class="cursor-pointer shadow-xl active:scale-125 transition-transform"
                        style="display: none; stroke: white; stroke-width: 3px; box-shadow: 0 0 15px rgba(124, 58, 237, 0.5);">
                        <animate attributeName="r" values="12;13;12" dur="2s" repeatCount="indefinite" />
                    </circle>
                </svg>

                <!-- Hand hint animation -->
                <div class="absolute bottom-4 right-4 pointer-events-none opacity-50 animate-bounce">
                    <i class="fas fa-hand-pointer text-2xl text-emerald-400"></i>
                </div>
            </div>

            <div id="trace-feedback" class="h-6 text-sm font-bold text-emerald-400 opacity-0 transition-opacity">
                Ajoyib! Davom eting...
            </div>
        </div>

        <!-- Step 5: Review (Tugadi) -->
        <div id="view-review" class="hidden text-center space-y-8">
            <div class="text-8xl text-green-400 animate-bounce">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="text-3xl font-bold">Ajoyib!</h2>
            <p class="text-gray-300">Siz <span class="text-cyan-400">{{ letter.name }}</span> harfini o'rgandingiz.</p>

            <div class="bg-gray-900 p-4 rounded-xl border border-gray-700 inline-block">
                <span id="xp-badge" class="text-yellow-400 font-bold text-xl">+10 XP</span>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <a href="{% url 'arab:alphabet' %}" class="py-3 px-6 bg-gray-700 rounded-lg hover:bg-gray-600">
                    Bosh menyu
                </a>
                <a href="{% url 'arab:letter_detail' pk=letter.id %}"
                    class="py-3 px-6 bg-cyan-600 rounded-lg hover:bg-cyan-500">
                    Qayta ko'rish
                </a>
            </div>
        </div>

    </div>
</div>

<script src="{% static 'js/spiral_practice.js' %}"></script>
{% endblock %}