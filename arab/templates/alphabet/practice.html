{% extends "base.html" %}
{% block title %}Writing{% endblock %}
{% block content %}

<!-- Header -->
<section class="relative overflow-hidden rounded-3xl border border-white/10 bg-white/5 p-6 md:p-10">
  <div class="pointer-events-none absolute -top-32 -left-32 h-80 w-80 rounded-full bg-emerald-400/15 blur-3xl"></div>
  <div class="pointer-events-none absolute -bottom-32 -right-32 h-80 w-80 rounded-full bg-sky-400/15 blur-3xl"></div>

  <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
    <div>
      <div class="text-xs text-slate-400">Practice • Writing</div>
      <h1 class="mt-1 text-3xl md:text-5xl font-black">
        ✍️ {{ letter.name }} yozish
      </h1>
      <p class="mt-2 text-slate-300 text-sm max-w-2xl leading-relaxed">
        Harfni yozishni mustahkamlash uchun mashq sahifasi. Hozircha canvas JS keyin qo‘shiladi.
        Hozir esa shakllarini ko‘rib, yozishni ketma-ket bajarib boring.
      </p>

      <div class="mt-5 flex flex-wrap gap-2">
        <span class="rounded-2xl border border-white/10 bg-slate-950/40 px-3 py-2 text-xs text-slate-300">✅
          Shakllar</span>
        <span class="rounded-2xl border border-white/10 bg-slate-950/40 px-3 py-2 text-xs text-slate-300">✅
          Qadamlar</span>
        <span class="rounded-2xl border border-white/10 bg-slate-950/40 px-3 py-2 text-xs text-slate-300">✅
          Mustahkamlash</span>
      </div>
    </div>

    <div class="flex gap-2">
      <a href="/alphabet/"
        class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-sm hover:bg-white/10 transition">
        ← Alifboga
      </a>
      <a href="/letters/{{ letter.id }}/"
        class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-sm hover:bg-white/10 transition">
        Harf detail
      </a>
    </div>
  </div>
</section>

<div class="mt-6 grid lg:grid-cols-3 gap-4">

  <!-- MAIN PRACTICE PANEL -->
  <section class="lg:col-span-2 rounded-3xl border border-white/10 bg-white/5 p-6">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm font-semibold text-white">Canvas mashq</div>
        <div class="text-xs text-slate-400 mt-1">JS keyin qo‘shiladi (hozir preview + yo‘l-yo‘riq)</div>
      </div>

      <div class="rounded-2xl border border-white/10 bg-slate-950/40 px-3 py-2 text-xs text-slate-300">
        Practice Mode
      </div>
    </div>

    <div class="mt-5 rounded-3xl border border-white/10 bg-slate-950/40 p-8 text-center" dir="rtl">
      <div class="arabic-font text-[110px] md:text-[140px] font-black leading-none text-white">
        {{ letter.arabic }}
      </div>
      <div class="mt-3 text-xs text-slate-400 [direction:ltr]">
        Harfni katta qilib ko‘ring va daftar/planchetda qayta-qayta yozing.
      </div>

      <!-- Functional drawing canvas -->
      <div
        class="mt-6 relative bg-white rounded-3xl overflow-hidden shadow-2xl border-4 border-slate-900 mx-auto aspect-square max-w-[500px]">
        <!-- Reference letter (ghost) -->
        <div class="absolute inset-0 flex items-center justify-center opacity-[0.03] pointer-events-none select-none">
          <div class="arabic-font text-[300px] text-slate-950 font-black">{{ letter.arabic }}</div>
        </div>
        <canvas id="practiceCanvas" class="relative z-10 w-full h-full cursor-crosshair"></canvas>

        <!-- Validation Overlay -->
        <div id="checkOverlay"
          class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-slate-950/80 backdrop-blur-md opacity-0 pointer-events-none transition-opacity duration-300">
          <div id="checkSpinner"
            class="h-16 w-16 border-4 border-emerald-500/20 border-t-emerald-500 rounded-full animate-spin"></div>
          <div id="checkResult" class="hidden text-center scale-75 opacity-0 transition-all duration-500">
            <div id="resultIcon" class="text-6xl mb-4">✨</div>
            <div id="resultText" class="text-2xl font-black text-white">To'g'ri!</div>
          </div>
        </div>
      </div>

      <div class="mt-6 flex justify-center gap-4">
        <button id="clearCanvas"
          class="px-6 py-3 rounded-2xl bg-white/5 border border-white/10 text-white font-bold text-sm hover:bg-white/10 transition">
          Tozalash
        </button>
        <button id="undoCanvas"
          class="px-6 py-3 rounded-2xl bg-white/5 border border-white/10 text-white font-bold text-sm hover:bg-white/10 transition">
          Ortga qaytarish
        </button>
        <button id="savePractice"
          class="px-8 py-3 rounded-2xl bg-emerald-500 text-slate-950 font-black text-sm hover:bg-emerald-400 transition">
          Tayyor
        </button>
      </div>
    </div>

    <!-- Quick tips -->
    <div class="mt-5 grid sm:grid-cols-3 gap-3">
      <div class="rounded-2xl border border-white/10 bg-white/5 p-4 hover:bg-white/10 transition">
        <div class="text-xs text-slate-400">Qadam 1</div>
        <div class="mt-1 text-sm text-white font-semibold">Shaklni ko‘r</div>
        <div class="mt-1 text-xs text-slate-400 leading-relaxed">Isolated/Initial/Medial/Final ko‘rinishlarini eslab
          qol.</div>
      </div>
      <div class="rounded-2xl border border-white/10 bg-white/5 p-4 hover:bg-white/10 transition">
        <div class="text-xs text-slate-400">Qadam 2</div>
        <div class="mt-1 text-sm text-white font-semibold">Sekin yoz</div>
        <div class="mt-1 text-xs text-slate-400 leading-relaxed">Avval sekin, keyin tezlikni oshir.</div>
      </div>
      <div class="rounded-2xl border border-white/10 bg-white/5 p-4 hover:bg-white/10 transition">
        <div class="text-xs text-slate-400">Qadam 3</div>
        <div class="mt-1 text-sm text-white font-semibold">Takrorla</div>
        <div class="mt-1 text-xs text-slate-400 leading-relaxed">10–20 marta yozib, keyin misolda ishlat.</div>
      </div>
    </div>
  </section>

  <!-- RIGHT SIDEBAR -->
  <aside class="rounded-3xl border border-white/10 bg-white/5 p-6" dir="rtl">
    <div class="[direction:ltr]">
      <div class="text-sm font-semibold text-white">Harf shakllari</div>
      <div class="text-xs text-slate-400 mt-1">Yozishda ketma-ket: Isolated → Initial → Medial → Final</div>
    </div>

    <div class="mt-5 grid grid-cols-2 gap-3">
      <div class="group rounded-2xl border border-white/10 bg-slate-950/40 p-4 text-center hover:bg-white/5 transition">
        <div class="text-xs text-slate-400 [direction:ltr]">Isolated</div>
        <div class="arabic-font text-4xl font-black mt-1 text-white group-hover:scale-110 transition">
          {{ letter.isolated|default:letter.arabic }}
        </div>
      </div>
      <div class="group rounded-2xl border border-white/10 bg-slate-950/40 p-4 text-center hover:bg-white/5 transition">
        <div class="text-xs text-slate-400 [direction:ltr]">Final</div>
        <div class="arabic-font text-4xl font-black mt-1 text-white group-hover:scale-110 transition">
          {{ letter.final|default:letter.arabic }}
        </div>
      </div>
      <div class="group rounded-2xl border border-white/10 bg-slate-950/40 p-4 text-center hover:bg-white/5 transition">
        <div class="text-xs text-slate-400 [direction:ltr]">Initial</div>
        <div class="arabic-font text-4xl font-black mt-1 text-white group-hover:scale-110 transition">
          {{ letter.initial|default:letter.arabic }}
        </div>
      </div>
      <div class="group rounded-2xl border border-white/10 bg-slate-950/40 p-4 text-center hover:bg-white/5 transition">
        <div class="text-xs text-slate-400 [direction:ltr]">Medial</div>
        <div class="arabic-font text-4xl font-black mt-1 text-white group-hover:scale-110 transition">
          {{ letter.medial|default:letter.arabic }}
        </div>
      </div>
    </div>

    <div class="mt-5 rounded-2xl border border-white/10 bg-white/5 p-4 [direction:ltr]">
      <div class="text-xs text-slate-400">Maslahat</div>
      <div class="mt-2 text-sm text-slate-200 leading-relaxed">
        Harfni yozganda <span class="text-white font-semibold">qalam bosimini</span> bir xil ushlang.
        Har bir shaklni alohida 5 marta yozib chiqing.
      </div>
    </div>
  </aside>

</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('practiceCanvas');
    const ctx = canvas.getContext('2d');
    const clearBtn = document.getElementById('clearCanvas');
    const undoBtn = document.getElementById('undoCanvas');
    const saveBtn = document.getElementById('savePractice');

    // Resize canvas for high resolution
    function resize() {
      const rect = canvas.parentElement.getBoundingClientRect();
      canvas.width = rect.width * devicePixelRatio;
      canvas.height = rect.height * devicePixelRatio;
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
      ctx.scale(devicePixelRatio, devicePixelRatio);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.lineWidth = 12;
      ctx.strokeStyle = '#0f172a'; // Slate 950
    }

    resize();
    window.addEventListener('resize', resize);

    let drawing = false;
    let paths = [];
    let currentPath = [];

    function startDrawing(e) {
      drawing = true;
      currentPath = [];
      draw(e);
    }

    function stopDrawing() {
      if (drawing) {
        paths.push([...currentPath]);
      }
      drawing = false;
      ctx.beginPath();
    }

    function draw(e) {
      if (!drawing) return;

      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX || e.touches[0].clientX) - rect.left;
      const y = (e.clientY || e.touches[0].clientY) - rect.top;

      currentPath.push({ x, y });

      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    window.addEventListener('mouseup', stopDrawing);

    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e.touches[0]); });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
    canvas.addEventListener('touchend', stopDrawing);

    clearBtn.addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      paths = [];
    });

    undoBtn.addEventListener('click', () => {
      paths.pop();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      paths.forEach(path => {
        if (path.length < 1) return;
        ctx.beginPath();
        ctx.moveTo(path[0].x, path[0].y);
        path.forEach(point => {
          ctx.lineTo(point.x, point.y);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(point.x, point.y);
        });
      });
    });

    saveBtn.addEventListener('click', () => {
      const totalPoints = paths.reduce((acc, p) => acc + p.length, 0);

      if (totalPoints < 10) {
        alert("Iltimos, avval harfni chizing!");
        return;
      }

      const overlay = document.getElementById('checkOverlay');
      const spinner = document.getElementById('checkSpinner');
      const result = document.getElementById('checkResult');
      const resultIcon = document.getElementById('resultIcon');
      const resultText = document.getElementById('resultText');

      // Show overlay
      overlay.classList.remove('opacity-0', 'pointer-events-none');
      overlay.classList.add('opacity-100');
      spinner.classList.remove('hidden');
      result.classList.add('hidden', 'scale-75', 'opacity-0');

      setTimeout(() => {
        // Robustness: check point density/count
        const isSuccess = totalPoints > 30; // Threshold for a real attempt

        spinner.classList.add('hidden');
        result.classList.remove('hidden');

        if (isSuccess) {
          resultIcon.innerText = '✨';
          resultText.innerText = 'Muvaffaqiyatli!';
          resultText.className = 'text-2xl font-black text-emerald-400';

          setTimeout(() => {
            window.location.href = "{% url 'arab:alphabet' %}";
          }, 1500);
        } else {
          resultIcon.innerText = '❌';
          resultText.innerText = 'Xato! Yaxshiroq chizishga harakat qiling';
          resultText.className = 'text-2xl font-black text-red-400';

          setTimeout(() => {
            overlay.classList.add('opacity-0', 'pointer-events-none');
            overlay.classList.remove('opacity-100');
            // Reset for retry
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            paths = [];
          }, 2000);
        }

        requestAnimationFrame(() => {
          result.classList.remove('scale-75', 'opacity-0');
          result.classList.add('scale-100', 'opacity-100');
        });
      }, 1500);
    });
  });
</script>

{% endblock %}