{% extends "base.html" %}
{% load static %}

{% block title %}Mashq: {{ letter.name }} - AlifPro Academy{% endblock %}

{% block content %}
<div id="practice-container" x-data="{ 
    step: 'intro', 
    playing: false,
    audioObj: null,
    playbackSpeed: 1.0,
    init() {
        {% if letter.pronunciations.first.audio %}
        this.audioObj = new Audio('{{ letter.pronunciations.first.audio.url }}');
        this.audioObj.load();
        this.audioObj.onended = () => { this.playing = false; };
        {% endif %}
    },
    setupAudio() {
        // Already handled in init for this page
    },
    playAudio() {
        if (!this.audioObj) this.setupAudio();
        
        if (this.audioObj) {
            this.audioObj.currentTime = 0;
            this.audioObj.playbackRate = this.playbackSpeed;
            let playPromise = this.audioObj.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    this.playing = true;
                }).catch(error => {
                    console.log('Audio play failed:', error);
                    this.useTTS();
                });
            }
        } else {
            this.useTTS();
        }
    },
    useTTS() {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance('{{ letter.arabic }}');
            utterance.lang = 'ar-SA';
            utterance.rate = this.playbackSpeed * 0.7; // TTS is usually fast
            utterance.onstart = () => { this.playing = true; };
            utterance.onend = () => { this.playing = false; };
            speechSynthesis.speak(utterance);
        }
    },
    nextStep(next) {
        this.step = next;
        // Trigger generic step change logic if needed
        window.dispatchEvent(new CustomEvent('step-changed', { detail: next }));
    }
}" x-init="init()" class="min-h-[90vh] flex items-center justify-center relative overflow-hidden px-4">

    <!-- Background Elements -->
    <div
        class="absolute -top-40 -left-40 w-[600px] h-[600px] bg-emerald-500/10 rounded-full blur-[120px] pointer-events-none">
    </div>
    <div
        class="absolute -bottom-40 -right-40 w-[600px] h-[600px] bg-sky-500/10 rounded-full blur-[120px] pointer-events-none">
    </div>

    <input type="hidden" id="letter-id" value="{{ letter.id }}">
    {% csrf_token %}

    <!-- Main Glassmorphism Container -->
    <div class="w-full max-w-xl relative animate-in fade-in duration-700">

        <!-- Step 1: Intro (Tanishish) -->
        <template x-if="step === 'intro'">
            <div
                class="relative rounded-[3rem] border border-white/10 bg-slate-900/40 backdrop-blur-2xl p-10 md:p-16 text-center space-y-12 shadow-2xl">
                <div class="space-y-4">
                    <h2 class="text-3xl font-black text-white uppercase tracking-tighter">Tanishish</h2>
                </div>

                <div class="relative group">
                    <div
                        class="absolute inset-0 bg-emerald-400/20 rounded-full blur-3xl scale-75 group-hover:scale-100 transition-transform duration-700">
                    </div>
                    <div
                        class="relative text-[180px] md:text-[240px] leading-none arabic-font text-white drop-shadow-2xl">
                        {{ letter.arabic }}
                    </div>
                </div>

                <div class="space-y-8">
                    <div class="text-white font-black text-4xl uppercase tracking-widest">{{ letter.name }}</div>

                    <button @click="nextStep('listen'); playAudio()"
                        class="w-full py-5 bg-white text-slate-950 rounded-3xl text-3xl font-black transition-all hover:scale-[1.02] active:scale-95 shadow-xl shadow-white/5">
                        BOSHLASH
                    </button>
                </div>
            </div>
        </template>

        <!-- Step 2: Listen (Tinglash) -->
        <template x-if="step === 'listen'">
            <div
                class="relative rounded-[3rem] border border-white/10 bg-slate-900/40 backdrop-blur-2xl p-10 md:p-16 text-center space-y-12 shadow-2xl">
                <div class="space-y-4">
                    <h2 class="text-3xl font-black text-white uppercase tracking-tighter">Tinglash</h2>
                </div>

                <div class="relative flex flex-col items-center gap-10">
                    <button @click="playAudio()"
                        class="group relative w-32 h-32 flex items-center justify-center rounded-full bg-white text-slate-950 shadow-2xl hover:scale-110 active:scale-95 transition-all outline-none border-0 overflow-hidden">
                        <i :class="playing ? 'fas fa-volume-up text-4xl animate-pulse' : 'fas fa-play text-4xl ml-2'"
                            class="relative z-10"></i>
                        <div x-show="playing" class="absolute inset-0 bg-purple-100 animate-ping opacity-20"></div>
                    </button>

                    <div class="flex flex-col gap-4 w-full">
                        <div class="flex justify-center gap-3">
                            <button @click="playbackSpeed = 1.0; playAudio()"
                                :class="playbackSpeed === 1.0 ? 'bg-purple-500/20 text-purple-400 border-purple-500/30' : 'bg-white/5 text-slate-400 border-white/10'"
                                class="flex-1 py-3 rounded-2xl border font-black text-[10px] tracking-widest transition-all hover:bg-white/10 uppercase">
                                ODATIY
                            </button>
                            <button @click="playbackSpeed = 0.75; playAudio()"
                                :class="playbackSpeed === 0.75 ? 'bg-purple-500/20 text-purple-400 border-purple-500/30' : 'bg-white/5 text-slate-400 border-white/10'"
                                class="flex-1 py-3 rounded-2xl border font-black text-[10px] tracking-widest transition-all hover:bg-white/10 uppercase">
                                0.75x (SEKIN)
                            </button>
                        </div>
                    </div>
                </div>

                <div class="pt-8">
                    <button @click="nextStep('select')"
                        class="w-full py-5 bg-purple-600 text-white rounded-3xl text-3xl font-black transition-all hover:bg-purple-500 hover:scale-[1.02] active:scale-95 shadow-xl shadow-purple-900/20">
                        TUSHUNDIM
                    </button>
                </div>
            </div>
        </template>

        <!-- Step 3: Select (Tanlash) -->
        <template x-if="step === 'select'">
            <div
                class="relative rounded-[3rem] border border-white/10 bg-slate-900/40 backdrop-blur-2xl p-10 md:p-12 text-center shadow-2xl overflow-hidden">
                <!-- Decorative background pulse -->
                <div x-show="playing" class="absolute inset-0 bg-yellow-500/5 animate-pulse pointer-events-none"></div>

                <div class="relative z-10 space-y-10">
                    <div class="flex flex-col items-center gap-4">
                        <h2 class="text-3xl font-black text-white uppercase tracking-tighter">Tanlash
                        </h2>

                        <button @click="playAudio()"
                            class="mt-2 group flex items-center gap-3 px-6 py-2 rounded-2xl bg-white/5 border border-white/10 text-white hover:bg-white/10 transition-all active:scale-95 shadow-lg shadow-black/20">
                            <i class="fas fa-volume-up text-yellow-400 group-hover:scale-110 transition-transform"
                                :class="playing ? 'animate-bounce' : ''"></i>
                            <span class="text-xs font-black tracking-widest uppercase">QAYTA TINGLASH</span>
                        </button>
                    </div>

                    <!-- LOGIC CONTAINER -->
                    <div id="logic-container" class="grid grid-cols-2 gap-6" data-correct="{{ letter.arabic }}">
                        {% for opt in options %}
                        <button type="button"
                            class="letter-btn group relative p-10 rounded-[2.5rem] bg-white/5 border border-white/10 hover:border-yellow-400/50 hover:bg-white/10 transition-all cursor-pointer shadow-lg active:scale-95 w-full h-full flex items-center justify-center outline-none"
                            data-letter="{{ opt.arabic }}">
                            <div
                                class="arabic-font text-8xl text-white group-hover:scale-110 transition-transform duration-300 pointer-events-none">
                                {{ opt.arabic }}
                            </div>
                        </button>
                        {% endfor %}
                    </div>

                    <style>
                        .letter-btn.correct {
                            background-color: #059669 !important;
                            /* emerald-600 */
                            border-color: #34d399 !important;
                            /* emerald-400 */
                            transform: scale(1.05);
                            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
                        }

                        .letter-btn.wrong {
                            background-color: #dc2626 !important;
                            /* red-600 */
                            border-color: #f87171 !important;
                            /* red-400 */
                            animation: shake 0.5s;
                        }

                        .letter-btn.disabled {
                            opacity: 0.5;
                            pointer-events: none;
                        }
                    </style>

                    <script>
                        (function () {
                            const container = document.getElementById('logic-container');
                            if (!container) return;

                            const CORRECT_LETTER = container.dataset.correct;
                            const buttons = container.querySelectorAll('.letter-btn');

                            buttons.forEach(btn => {
                                btn.addEventListener('click', function (e) {
                                    // PREVENT MUTLIPLE CLICKS
                                    if (container.dataset.locked === "true") return;
                                    container.dataset.locked = "true";

                                    const selectedLetter = this.dataset.letter;
                                    const isCorrect = selectedLetter === CORRECT_LETTER;

                                    // DISABLE ALL
                                    buttons.forEach(b => b.classList.add('disabled'));
                                    this.classList.remove('disabled'); // Keep selected opaque

                                    if (isCorrect) {
                                        this.classList.add('correct');
                                        if (window.playCorrect) window.playCorrect();

                                        // TRIGGER NEXT LETTER OR FINISH
                                        setTimeout(() => {
                                            const nextUrl = "{% if next_letter %}{% url 'arab:letter_practice' pk=next_letter.id %}{% else %}{% url 'arab:alphabet' %}{% endif %}";
                                            window.location.href = nextUrl;
                                        }, 1000);
                                    } else {
                                        this.classList.add('wrong');
                                        if (window.playWrong) window.playWrong();

                                        // STRICT: NO RETRY. USER MUST REFRESH or RESTART SESSION IF NEEDED.
                                        // HOWEVER, to prevent broken flow in a real app, we might unlock.
                                        // BUT PROMPT SAID: "Disabled state... Prevent any further clicks".
                                        // So we leave it DISABLED.
                                    }
                                });
                            });
                        })();
                    </script>
                </div>
            </div>
        </template>

        <!-- Step 4: Write (Yozish) -->
        <template x-if="step === 'write'">
            <div id="view-write"
                class="relative rounded-[3rem] border border-white/10 bg-slate-900/40 backdrop-blur-2xl p-10 md:p-12 text-center space-y-10 shadow-2xl">
                <div class="space-y-4">
                    <h2 class="text-3xl font-black text-white uppercase tracking-tighter">Yozish</h2>
                </div>

                <!-- Professional Tracing Container -->
                <div
                    class="relative w-full aspect-square max-w-[320px] mx-auto rounded-[3rem] bg-slate-950/50 border border-white/5 shadow-inner overflow-hidden touch-none group">
                    <svg x-ref="drawingSvg" id="practice-svg" viewBox="{{ letter.viewbox }}"
                        class="relative z-10 w-full h-full p-12 overflow-visible">
                        <path d="{{ letter.svg_path }}" stroke="rgba(255,255,255,0.05)" stroke-width="2"
                            stroke-dasharray="4,4" fill="none" />
                        <path id="letter-path" d="{{ letter.svg_path }}" stroke="#34d399" stroke-width="16" fill="none"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>

                <div class="flex flex-col items-center gap-6">
                    <div id="trace-feedback"
                        class="h-6 text-sm font-black text-emerald-400 opacity-0 transition-opacity uppercase tracking-widest">
                        AJOYIB!
                    </div>

                    <button id="btn-clear-trace"
                        class="px-10 py-4 rounded-2xl bg-white/5 border border-white/10 text-white font-black hover:bg-white/10 transition-all flex items-center justify-center gap-3 shadow-lg text-2xl">
                        <i class="fas fa-eraser text-emerald-400 text-sm"></i>
                        <span>TOZALASH</span>
                    </button>
                </div>
            </div>
        </template>

        <!-- Step 5: Review (Tugadi) -->
        <template x-if="step === 'review'">
            <div
                class="relative rounded-[3rem] border border-white/10 bg-slate-900/40 backdrop-blur-2xl p-10 md:p-16 text-center space-y-12 shadow-2xl overflow-hidden">
                <!-- Celebration Background -->
                <div class="absolute inset-0 bg-gradient-to-t from-emerald-500/10 to-transparent pointer-events-none">
                </div>

                <div class="relative z-10 space-y-8 animate-in zoom-in duration-500">
                    <div class="relative inline-block">
                        <div class="absolute inset-0 bg-emerald-400 blur-3xl opacity-20 animate-pulse"></div>
                        <i class="fas fa-check-circle text-[100px] text-emerald-400 relative z-10"></i>
                    </div>

                    <div class="space-y-4">
                        <h2 class="text-4xl font-black text-white uppercase tracking-tighter">MUBORAK BO'LSIN!
                        </h2>
                        <p class="text-slate-400 text-lg">Siz <span class="text-white font-bold">{{ letter.name
                                }}</span> harfini muvaffaqiyatli tamomladingiz.</p>
                    </div>

                    <div
                        class="inline-flex items-center gap-4 px-8 py-4 rounded-3xl bg-slate-950 border border-white/10 shadow-xl">
                        <span class="text-slate-500 font-bold uppercase tracking-widest text-[10px]">MUKOFOT</span>
                        <span id="xp-badge" class="text-yellow-400 font-black text-2xl tracking-tight">+10 XP</span>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-6">
                        <a href="{% url 'arab:alphabet' %}"
                            class="py-4 px-6 bg-white/5 border border-white/10 text-white rounded-2xl font-black hover:bg-white/10 transition-all flex items-center justify-center gap-2">
                            BOSH MENYU
                        </a>
                        <a href="{% url 'arab:letter_detail' pk=letter.id %}"
                            class="py-4 px-6 bg-emerald-600 text-white rounded-2xl font-black hover:bg-emerald-500 transition-all shadow-lg shadow-emerald-900/20 flex items-center justify-center gap-2">
                            QAYTA KO'RISH
                        </a>
                    </div>
                </div>
            </div>
        </template>

    </div>
</div>

<style>
    .arabic-font {
        font-family: 'Noto Naskh Arabic', serif;
    }

    .shake {
        animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
    }

    @keyframes shake {

        10%,
        90% {
            transform: translate3d(-1px, 0, 0);
        }

        20%,
        80% {
            transform: translate3d(2px, 0, 0);
        }

        30%,
        50%,
        70% {
            transform: translate3d(-4px, 0, 0);
        }

        40%,
        60% {
            transform: translate3d(4px, 0, 0);
        }
    }
</style>

<script>
    // Bridge between Alpine.js and existing spiral_practice.js logic
    window.addEventListener('step-changed', (e) => {
        const stepName = e.detail;
        if (typeof window.reinitStep === 'function') {
            window.reinitStep(stepName);
        }
    });

    // Helper for Select step since it's dynamic
    function handleSelect(e) {
        const btn = e.currentTarget;
        const isCorrect = btn.dataset.correct === "true";
        if (typeof window.handleQuizSelect === 'function') {
            window.handleQuizSelect(btn, isCorrect);
        }
    }
</script>

<script src="{% static 'js/spiral_practice.js' %}"></script>
{% endblock %}