{% extends "base.html" %}
{% load static %}

{% block title %}Mashq: {{ letter.name }} - AlifPro Academy{% endblock %}

{% block content %}
<div id="practice-container" x-data="{ 
    step: 'intro', 
    playing: false,
    audioObj: null,
    playbackSpeed: 1.0,
    listenCount: 0,
    googleTtsApiKey: 'AIzaSyDQwhqE2-3u5W-feLg3BU0N0SmIAfY6WJw',
    audioCache: {},
    
    init() {
        {% if letter.pronunciations.first.audio %}
        this.audioObj = new Audio('{{ letter.pronunciations.first.audio.url }}');
        this.audioObj.load();
        this.audioObj.onended = () => { this.playing = false; };
        {% endif %}
    },
    
    async playAudio() {
        if (this.playing) return;
        this.playing = true;
        
        const text = '{{ letter.arabic }}';
        
        // Try sources in order: 1) Uploaded audio, 2) Google TTS, 3) Browser TTS
        if (this.audioObj) {
            this.audioObj.currentTime = 0;
            this.audioObj.playbackRate = this.playbackSpeed;
            try {
                await this.audioObj.play();
            } catch (error) {
                console.log('Audio play failed, trying Google TTS:', error);
                await this.playGoogleTTS(text);
            }
        } else {
            try {
                await this.playGoogleTTS(text);
            } catch (error) {
                console.log('Google TTS failed, using browser TTS:', error);
                this.playBrowserTTS(text);
            }
        }
    },
    
    async playGoogleTTS(text) {
        // Check cache
        const cacheKey = text + '_' + this.playbackSpeed;
        if (this.audioCache[cacheKey]) {
            return this.playAudioFromBase64(this.audioCache[cacheKey]);
        }
        
        const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${this.googleTtsApiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                input: { text: text },
                voice: {
                    languageCode: 'ar-XA',
                    name: 'ar-XA-Wavenet-A',
                    ssmlGender: 'FEMALE'
                },
                audioConfig: {
                    audioEncoding: 'MP3',
                    speakingRate: this.playbackSpeed * 0.85,
                    pitch: 0
                }
            })
        });
        
        if (!response.ok) throw new Error(`Google TTS error: ${response.status}`);
        
        const data = await response.json();
        this.audioCache[cacheKey] = data.audioContent;
        return this.playAudioFromBase64(data.audioContent);
    },
    
    playAudioFromBase64(base64Audio) {
        return new Promise((resolve, reject) => {
            const audio = new Audio(`data:audio/mp3;base64,${base64Audio}`);
            audio.onended = () => { this.playing = false; resolve(); };
            audio.onerror = (e) => { this.playing = false; reject(e); };
            audio.play().catch(reject);
        });
    },
    
    playBrowserTTS(text) {
        if ('speechSynthesis' in window) {
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = speechSynthesis.getVoices();
            const arabicVoice = voices.find(v => v.lang.startsWith('ar'));
            if (arabicVoice) utterance.voice = arabicVoice;
            utterance.lang = 'ar-SA';
            utterance.rate = this.playbackSpeed * 0.6;
            utterance.onend = () => { this.playing = false; };
            utterance.onerror = () => { this.playing = false; };
            speechSynthesis.speak(utterance);
            setTimeout(() => { if (this.playing) this.playing = false; }, 3000);
        } else {
            this.playing = true;
            setTimeout(() => { this.playing = false; }, 500);
        }
    },
    
    nextStep(next) {
        this.step = next;
        window.dispatchEvent(new CustomEvent('step-changed', { detail: next }));
    }
}" x-init="init()" class="min-h-[90vh] flex items-center justify-center relative overflow-hidden px-4">

    <!-- Background Elements -->
    <div
        class="absolute -top-40 -left-40 w-[600px] h-[600px] bg-emerald-500/10 rounded-full blur-[120px] pointer-events-none">
    </div>
    <div
        class="absolute -bottom-40 -right-40 w-[600px] h-[600px] bg-sky-500/10 rounded-full blur-[120px] pointer-events-none">
    </div>

    <input type="hidden" id="letter-id" value="{{ letter.id }}">
    {% csrf_token %}

    <!-- Main Glassmorphism Container -->
    <div class="w-full max-w-xl relative animate-in fade-in duration-700">

        <!-- Step 1: Intro (Tanishish) - ENHANCED -->
        <template x-if="step === 'intro'">
            <div
                class="relative rounded-[3rem] border border-white/10 bg-slate-900/40 backdrop-blur-2xl p-10 md:p-16 text-center space-y-10 shadow-2xl overflow-hidden">

                <!-- Decorative gradient background -->
                <div
                    class="absolute inset-0 bg-gradient-to-br from-emerald-500/5 via-transparent to-sky-500/5 pointer-events-none">
                </div>

                <div class="relative z-10 space-y-4">
                    <div
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-[10px] font-black uppercase tracking-[0.3em] text-emerald-400">
                        <i class="fas fa-star"></i> 1-QADAM
                    </div>
                    <h2 class="text-3xl font-black text-white uppercase tracking-tighter">Tanishish</h2>
                    <p class="text-slate-500 text-sm">Yangi harf bilan tanishing</p>
                </div>

                <!-- Animated Letter Display -->
                <div class="relative group py-8">
                    <div
                        class="absolute inset-0 bg-emerald-400/20 rounded-full blur-[100px] scale-50 group-hover:scale-100 transition-all duration-1000">
                    </div>
                    <div
                        class="relative text-[180px] md:text-[260px] leading-none arabic-font text-white drop-shadow-2xl animate-float select-none hover:text-emerald-300 transition-colors cursor-default">
                        {{ letter.arabic }}
                    </div>
                </div>

                <!-- Letter Info Card -->
                <div class="space-y-6">
                    <div
                        class="inline-flex items-center gap-4 px-8 py-4 rounded-3xl bg-slate-950/50 border border-white/10 shadow-xl">
                        <span class="text-4xl font-black text-white uppercase tracking-widest">{{ letter.name }}</span>
                    </div>

                    <!-- Progress Dots -->
                    <div class="flex justify-center gap-2 py-4">
                        <div class="w-3 h-3 rounded-full bg-emerald-500 shadow-lg shadow-emerald-500/50"></div>
                        <div class="w-3 h-3 rounded-full bg-white/20"></div>
                        <div class="w-3 h-3 rounded-full bg-white/20"></div>
                        <div class="w-3 h-3 rounded-full bg-white/20"></div>
                    </div>

                    <!-- Start Button -->
                    <button @click="nextStep('listen'); playAudio()"
                        class="group w-full py-5 bg-gradient-to-r from-emerald-500 to-emerald-400 text-slate-950 rounded-3xl text-xl font-black transition-all hover:from-emerald-400 hover:to-emerald-300 hover:scale-[1.02] active:scale-95 shadow-xl shadow-emerald-500/20 flex items-center justify-center gap-3">
                        <span>BOSHLASH</span>
                        <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>
        </template>

        <!-- Step 2: Listen (Tinglash) - ENHANCED -->
        <template x-if="step === 'listen'">
            <div
                class="relative rounded-[3rem] border border-white/10 bg-slate-900/40 backdrop-blur-2xl p-10 md:p-16 text-center space-y-10 shadow-2xl overflow-hidden">

                <!-- Animated background pulse when playing -->
                <div x-show="playing"
                    class="absolute inset-0 bg-gradient-to-t from-purple-500/10 to-transparent animate-pulse pointer-events-none">
                </div>

                <div class="relative z-10 space-y-4">
                    <div
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-purple-500/10 border border-purple-500/20 text-[10px] font-black uppercase tracking-[0.3em] text-purple-400">
                        <i class="fas fa-headphones"></i> 2-QADAM
                    </div>
                    <h2 class="text-3xl font-black text-white uppercase tracking-tighter">Tinglash</h2>
                    <p class="text-slate-500 text-sm">Harfning talaffuzini diqqat bilan tinglang</p>
                </div>

                <!-- Large Letter Display with Glow Effect -->
                <div class="relative flex flex-col items-center gap-8">
                    <div class="relative group">
                        <div :class="playing ? 'scale-100 opacity-30' : 'scale-50 opacity-0'"
                            class="absolute inset-0 bg-purple-400 rounded-full blur-[80px] transition-all duration-700 pointer-events-none">
                        </div>
                        <span :class="playing ? 'text-purple-400 scale-110' : 'text-white'"
                            class="arabic-font relative z-10 block text-[140px] md:text-[180px] font-black leading-none transition-all duration-500 select-none">
                            {{ letter.arabic }}
                        </span>
                    </div>

                    <!-- Audio Waveform Visualization -->
                    <div x-show="playing" class="flex items-end justify-center gap-1 h-8">
                        <template x-for="i in 12">
                            <div class="w-1 bg-purple-400 rounded-full animate-pulse"
                                :style="`height: ${Math.random() * 24 + 8}px; animation-delay: ${i * 0.1}s`"></div>
                        </template>
                    </div>

                    <!-- Play Button with Ring Animation -->
                    <button @click="playAudio(); listenCount++"
                        class="group relative w-28 h-28 flex items-center justify-center rounded-full bg-white text-slate-950 shadow-2xl hover:scale-110 active:scale-95 transition-all outline-none border-0 overflow-hidden">
                        <div :class="playing ? 'scale-100' : 'scale-0'"
                            class="absolute inset-0 bg-purple-200 rounded-full transition-transform duration-300"></div>
                        <i :class="playing ? 'fas fa-volume-up text-3xl' : 'fas fa-play text-3xl ml-1'"
                            class="relative z-10 transition-all"></i>
                        <!-- Pulse rings when playing -->
                        <div x-show="playing"
                            class="absolute inset-0 rounded-full border-4 border-purple-400 animate-ping opacity-30">
                        </div>
                    </button>

                    <!-- Listen Counter -->
                    <div class="flex items-center gap-2 text-slate-500 text-xs font-bold">
                        <i class="fas fa-redo"></i>
                        <span x-text="listenCount + ' marta tinglandi'"></span>
                    </div>
                </div>

                <!-- Speed Controls - Enhanced -->
                <div class="flex flex-col gap-4 w-full max-w-sm mx-auto">
                    <div class="text-[10px] uppercase tracking-widest text-slate-600 font-bold">Tezlik</div>
                    <div class="grid grid-cols-4 gap-2">
                        <button @click="playbackSpeed = 0.5; playAudio(); listenCount++"
                            :class="playbackSpeed === 0.5 ? 'bg-purple-500 text-white border-purple-400 shadow-lg shadow-purple-500/20' : 'bg-white/5 text-slate-400 border-white/10 hover:bg-white/10'"
                            class="py-3 rounded-xl border font-black text-xs transition-all">
                            0.5x
                        </button>
                        <button @click="playbackSpeed = 0.75; playAudio(); listenCount++"
                            :class="playbackSpeed === 0.75 ? 'bg-purple-500 text-white border-purple-400 shadow-lg shadow-purple-500/20' : 'bg-white/5 text-slate-400 border-white/10 hover:bg-white/10'"
                            class="py-3 rounded-xl border font-black text-xs transition-all">
                            0.75x
                        </button>
                        <button @click="playbackSpeed = 1.0; playAudio(); listenCount++"
                            :class="playbackSpeed === 1.0 ? 'bg-purple-500 text-white border-purple-400 shadow-lg shadow-purple-500/20' : 'bg-white/5 text-slate-400 border-white/10 hover:bg-white/10'"
                            class="py-3 rounded-xl border font-black text-xs transition-all">
                            1x
                        </button>
                        <button @click="playbackSpeed = 1.25; playAudio(); listenCount++"
                            :class="playbackSpeed === 1.25 ? 'bg-purple-500 text-white border-purple-400 shadow-lg shadow-purple-500/20' : 'bg-white/5 text-slate-400 border-white/10 hover:bg-white/10'"
                            class="py-3 rounded-xl border font-black text-xs transition-all">
                            1.25x
                        </button>
                    </div>
                </div>

                <!-- Tip Box -->
                <div x-show="listenCount >= 2 && !showTip" x-transition
                    class="bg-emerald-500/10 border border-emerald-500/20 rounded-2xl p-4 text-sm text-emerald-400">
                    <i class="fas fa-lightbulb mr-2"></i>
                    Yaxshi! Endi harfni tanib olishga tayyormisiz?
                </div>

                <!-- Continue Button -->
                <div class="pt-4">
                    <button @click="nextStep('select')"
                        class="group w-full py-5 bg-gradient-to-r from-purple-600 to-purple-500 text-white rounded-3xl text-xl font-black transition-all hover:from-purple-500 hover:to-purple-400 hover:scale-[1.02] active:scale-95 shadow-xl shadow-purple-900/30 flex items-center justify-center gap-3">
                        <span>TUSHUNDIM</span>
                        <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>
        </template>

        <!-- Step 3: Select (Tanlash) -->
        <template x-if="step === 'select'">
            <div
                class="relative rounded-[3rem] border border-white/10 bg-slate-900/40 backdrop-blur-2xl p-10 md:p-12 text-center shadow-2xl overflow-hidden">
                <!-- Decorative background pulse -->
                <div x-show="playing" class="absolute inset-0 bg-yellow-500/5 animate-pulse pointer-events-none"></div>

                <div class="relative z-10 space-y-10">
                    <div class="flex flex-col items-center gap-4">
                        <h2 class="text-3xl font-black text-white uppercase tracking-tighter">Tanlash
                        </h2>

                        <button @click="playAudio()"
                            class="mt-2 group flex items-center gap-3 px-6 py-2 rounded-2xl bg-white/5 border border-white/10 text-white hover:bg-white/10 transition-all active:scale-95 shadow-lg shadow-black/20">
                            <i class="fas fa-volume-up text-yellow-400 group-hover:scale-110 transition-transform"
                                :class="playing ? 'animate-bounce' : ''"></i>
                            <span class="text-xs font-black tracking-widest uppercase">QAYTA TINGLASH</span>
                        </button>
                    </div>

                    <!-- LOGIC CONTAINER -->
                    <div id="logic-container" class="grid grid-cols-2 gap-6" data-correct="{{ letter.arabic }}">
                        {% for opt in options %}
                        <button type="button"
                            class="letter-btn group relative p-10 rounded-[2.5rem] bg-white/5 border border-white/10 hover:border-yellow-400/50 hover:bg-white/10 transition-all cursor-pointer shadow-lg active:scale-95 w-full h-full flex items-center justify-center outline-none"
                            data-letter="{{ opt.arabic }}">
                            <div
                                class="arabic-font text-8xl text-white group-hover:scale-110 transition-transform duration-300 pointer-events-none">
                                {{ opt.arabic }}
                            </div>
                        </button>
                        {% endfor %}
                    </div>

                    <style>
                        .letter-btn.correct {
                            background-color: #059669 !important;
                            /* emerald-600 */
                            border-color: #34d399 !important;
                            /* emerald-400 */
                            transform: scale(1.05);
                            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
                        }

                        .letter-btn.wrong {
                            background-color: #dc2626 !important;
                            /* red-600 */
                            border-color: #f87171 !important;
                            /* red-400 */
                            animation: shake 0.5s;
                        }

                        .letter-btn.disabled {
                            opacity: 0.5;
                            pointer-events: none;
                        }
                    </style>

                    <script>
                        (function () {
                            const container = document.getElementById('logic-container');
                            if (!container) return;

                            const CORRECT_LETTER = container.dataset.correct;
                            const buttons = container.querySelectorAll('.letter-btn');

                            buttons.forEach(btn => {
                                btn.addEventListener('click', function (e) {
                                    // PREVENT MUTLIPLE CLICKS
                                    if (container.dataset.locked === "true") return;
                                    container.dataset.locked = "true";

                                    const selectedLetter = this.dataset.letter;
                                    const isCorrect = selectedLetter === CORRECT_LETTER;

                                    // DISABLE ALL
                                    buttons.forEach(b => b.classList.add('disabled'));
                                    this.classList.remove('disabled'); // Keep selected opaque

                                    if (isCorrect) {
                                        this.classList.add('correct');
                                        if (window.playCorrect) window.playCorrect();

                                        // TRIGGER NEXT LETTER OR FINISH
                                        setTimeout(() => {
                                            const nextUrl = "{% if next_letter %}{% url 'arab:letter_practice' pk=next_letter.id %}{% else %}{% url 'arab:alphabet' %}{% endif %}";
                                            window.location.href = nextUrl;
                                        }, 1000);
                                    } else {
                                        this.classList.add('wrong');
                                        if (window.playWrong) window.playWrong();

                                        // STRICT: NO RETRY. USER MUST REFRESH or RESTART SESSION IF NEEDED.
                                        // HOWEVER, to prevent broken flow in a real app, we might unlock.
                                        // BUT PROMPT SAID: "Disabled state... Prevent any further clicks".
                                        // So we leave it DISABLED.
                                    }
                                });
                            });
                        })();
                    </script>
                </div>
            </div>
        </template>

        <!-- Step 4: Write (Yozish) -->
        <template x-if="step === 'write'">
            <div id="view-write"
                class="relative rounded-[3rem] border border-white/10 bg-slate-900/40 backdrop-blur-2xl p-10 md:p-12 text-center space-y-10 shadow-2xl">
                <div class="space-y-4">
                    <h2 class="text-3xl font-black text-white uppercase tracking-tighter">Yozish</h2>
                </div>

                <!-- Professional Tracing Container -->
                <div
                    class="relative w-full aspect-square max-w-[320px] mx-auto rounded-[3rem] bg-slate-950/50 border border-white/5 shadow-inner overflow-hidden touch-none group">
                    <svg x-ref="drawingSvg" id="practice-svg" viewBox="{{ letter.viewbox }}"
                        class="relative z-10 w-full h-full p-12 overflow-visible">
                        <path d="{{ letter.svg_path }}" stroke="rgba(255,255,255,0.05)" stroke-width="2"
                            stroke-dasharray="4,4" fill="none" />
                        <path id="letter-path" d="{{ letter.svg_path }}" stroke="#34d399" stroke-width="16" fill="none"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>

                <div class="flex flex-col items-center gap-6">
                    <div id="trace-feedback"
                        class="h-6 text-sm font-black text-emerald-400 opacity-0 transition-opacity uppercase tracking-widest">
                        AJOYIB!
                    </div>

                    <button id="btn-clear-trace"
                        class="px-10 py-4 rounded-2xl bg-white/5 border border-white/10 text-white font-black hover:bg-white/10 transition-all flex items-center justify-center gap-3 shadow-lg text-2xl">
                        <i class="fas fa-eraser text-emerald-400 text-sm"></i>
                        <span>TOZALASH</span>
                    </button>
                </div>
            </div>
        </template>

        <!-- Step 5: Review (Tugadi) -->
        <template x-if="step === 'review'">
            <div
                class="relative rounded-[3rem] border border-white/10 bg-slate-900/40 backdrop-blur-2xl p-10 md:p-16 text-center space-y-12 shadow-2xl overflow-hidden">
                <!-- Celebration Background -->
                <div class="absolute inset-0 bg-gradient-to-t from-emerald-500/10 to-transparent pointer-events-none">
                </div>

                <div class="relative z-10 space-y-8 animate-in zoom-in duration-500">
                    <div class="relative inline-block">
                        <div class="absolute inset-0 bg-emerald-400 blur-3xl opacity-20 animate-pulse"></div>
                        <i class="fas fa-check-circle text-[100px] text-emerald-400 relative z-10"></i>
                    </div>

                    <div class="space-y-4">
                        <h2 class="text-4xl font-black text-white uppercase tracking-tighter">MUBORAK BO'LSIN!
                        </h2>
                        <p class="text-slate-400 text-lg">Siz <span class="text-white font-bold">{{ letter.name
                                }}</span> harfini muvaffaqiyatli tamomladingiz.</p>
                    </div>

                    <div
                        class="inline-flex items-center gap-4 px-8 py-4 rounded-3xl bg-slate-950 border border-white/10 shadow-xl">
                        <span class="text-slate-500 font-bold uppercase tracking-widest text-[10px]">MUKOFOT</span>
                        <span id="xp-badge" class="text-yellow-400 font-black text-2xl tracking-tight">+10 XP</span>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-6">
                        <a href="{% url 'arab:alphabet' %}"
                            class="py-4 px-6 bg-white/5 border border-white/10 text-white rounded-2xl font-black hover:bg-white/10 transition-all flex items-center justify-center gap-2">
                            BOSH MENYU
                        </a>
                        <a href="{% url 'arab:letter_detail' pk=letter.id %}"
                            class="py-4 px-6 bg-emerald-600 text-white rounded-2xl font-black hover:bg-emerald-500 transition-all shadow-lg shadow-emerald-900/20 flex items-center justify-center gap-2">
                            QAYTA KO'RISH
                        </a>
                    </div>
                </div>
            </div>
        </template>

    </div>
</div>

<style>
    .arabic-font {
        font-family: 'Noto Naskh Arabic', serif;
    }

    .shake {
        animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
    }

    .animate-float {
        animation: float 3s ease-in-out infinite;
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0px);
        }

        50% {
            transform: translateY(-10px);
        }
    }

    @keyframes shake {

        10%,
        90% {
            transform: translate3d(-1px, 0, 0);
        }

        20%,
        80% {
            transform: translate3d(2px, 0, 0);
        }

        30%,
        50%,
        70% {
            transform: translate3d(-4px, 0, 0);
        }

        40%,
        60% {
            transform: translate3d(4px, 0, 0);
        }
    }
</style>

<script>
    // Bridge between Alpine.js and existing spiral_practice.js logic
    window.addEventListener('step-changed', (e) => {
        const stepName = e.detail;
        if (typeof window.reinitStep === 'function') {
            window.reinitStep(stepName);
        }
    });

    // Helper for Select step since it's dynamic
    function handleSelect(e) {
        const btn = e.currentTarget;
        const isCorrect = btn.dataset.correct === "true";
        if (typeof window.handleQuizSelect === 'function') {
            window.handleQuizSelect(btn, isCorrect);
        }
    }
</script>

<script src="{% static 'js/spiral_practice.js' %}"></script>
{% endblock %}