{% extends "base.html" %}
{% load sanitize %}

{% block title %}{{ letter.name|safe_text }} Harfi - AlifPro Academy{% endblock %}

{% block content %}
<div x-data="{ 
    playing: false,
    activeForm: 'isolated',
    playAudio(url) {
        if (!url) return;
        let audio = new Audio(url);
        audio.play();
        this.playing = true;
        audio.onended = () => { this.playing = false; };
    }
}" class="space-y-10 pb-12">

  <!-- HERO SECTION: Premium Immersive Header -->
  <section
    class="relative overflow-hidden rounded-[3rem] border border-white/10 bg-slate-900/60 backdrop-blur-xl p-8 md:p-12">
    <div
      class="pointer-events-none absolute -top-40 -left-40 h-[500px] w-[500px] rounded-full bg-emerald-500/10 blur-[120px]">
    </div>

    <div class="relative z-10 flex flex-col lg:flex-row items-center justify-between gap-8">
      <div class="flex-1 space-y-4 text-center lg:text-left">
        <div
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-[10px] font-black uppercase tracking-widest text-slate-400">
          Alifbo ‚Ä¢ #{{ letter.order }}
        </div>
        <h1 class="text-5xl md:text-7xl font-black text-white leading-tight">
          {{ letter.name }} <span
            class="bg-gradient-to-r from-emerald-400 to-sky-400 bg-clip-text text-transparent">Harfi</span>
        </h1>
        <p class="text-slate-400 text-lg max-w-xl leading-relaxed mx-auto lg:mx-0">
          Ushbu harfni yozilish shakllari, talaffuz qoidalari va real so'zlardagi misollar orqali chuqurroq o'rganing.
        </p>
        <div class="flex flex-wrap justify-center lg:justify-start gap-4 pt-2">
          <a href="{% url 'arab:letter_practice' letter.id %}"
            class="flex items-center gap-3 px-6 py-3 rounded-2xl bg-white text-slate-950 font-bold hover:bg-emerald-400 transition-all active:scale-95 shadow-lg shadow-white/5">
            <i class="fas fa-pen-nib"></i>
            <span>YOZISHNI MASHQ QILISH</span>
          </a>
        </div>
      </div>

      <!-- Large Letter Visual (Static in Hero) -->
      <div class="relative group">
        <div
          class="relative w-48 h-48 md:w-56 md:h-56 flex items-center justify-center rounded-[2.5rem] bg-white/5 border border-white/10 backdrop-blur-xl">
          <span class="arabic-font text-[100px] md:text-[120px] font-black text-white select-none" dir="rtl">
            {{ letter.arabic }}
          </span>
        </div>
      </div>
    </div>
  </section>

  <!-- PROFESSIONAL ARABIC LISTENING SECTION (Audio-First) -->
  {% if audio_url %}
  <section x-data="{ 
        audioPlaying: false, 
        speed: 1.0, 
        repeat: false,
        progress: 0,
        duration: 0,
        audioObj: null,
        init() {
            this.audioObj = new Audio('{{ audio_url }}');
            this.audioObj.preload = 'auto'; // Preload for no lag
            this.audioObj.addEventListener('loadedmetadata', () => {
                this.duration = this.audioObj.duration;
            });
            this.audioObj.addEventListener('timeupdate', () => {
                this.progress = (this.audioObj.currentTime / this.duration) * 100;
            });
            this.audioObj.onended = () => { 
                if (this.repeat) {
                    this.play();
                } else {
                    this.audioPlaying = false; 
                    this.progress = 0;
                }
            };
            window.addEventListener('keydown', (e) => {
                if (e.code === 'Space') {
                    e.preventDefault();
                    this.toggle();
                }
            });
        },
        play() {
            if (!this.audioObj) this.init();
            this.audioObj.playbackRate = this.speed;
            this.audioObj.play().catch(e => console.error(e));
            this.audioPlaying = true;
        },
        pause() {
            if (this.audioObj) {
                this.audioObj.pause();
            }
            this.audioPlaying = false;
        },
        toggle() {
            if (this.audioPlaying) this.pause();
            else this.play();
        },
        setSpeed(s) {
            this.speed = s;
            if (this.audioObj) this.audioObj.playbackRate = s;
        },
        seek(event) {
            if (!this.audioObj) return;
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const width = rect.width;
            const pct = x / width;
            this.audioObj.currentTime = pct * this.duration;
        }
    }"
    class="relative rounded-[2.5rem] md:rounded-[3rem] border border-white/10 bg-slate-900/40 backdrop-blur-xl p-6 md:p-16 text-center shadow-2xl overflow-hidden group">

    <div class="absolute inset-0 bg-gradient-to-b from-emerald-500/5 to-transparent pointer-events-none"></div>

    <div class="relative z-10 space-y-8 md:space-y-12">
      <!-- Label -->
      <div
        class="inline-flex items-center gap-3 px-5 py-2 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-[10px] md:text-[11px] font-black uppercase tracking-[0.3em] text-emerald-400">
        TALAFFUZI
      </div>

      <!-- Large Letter Visual with Dynamic Highlight -->
      <div class="relative inline-block scale-100 md:scale-125">
        <div :class="audioPlaying ? 'scale-110 blur-3xl opacity-30 px-20' : 'scale-0 opacity-0'"
          class="absolute inset-0 bg-emerald-400 rounded-full transition-all duration-700 pointer-events-none"></div>
        <span :class="audioPlaying ? 'text-emerald-400 scale-105' : 'text-white'"
          class="arabic-font relative z-10 block text-[120px] md:text-[240px] font-black leading-none transition-all duration-300 select-none cursor-pointer hover:text-emerald-300"
          @click="toggle()">
          {{ letter.arabic }}
        </span>
      </div>

      <!-- Controls (Professional Audio Controls) -->
      <div class="flex flex-col items-center gap-8 w-full max-w-xl mx-auto">

        <!-- Timeline -->
        <div class="w-full flex items-center gap-3 text-xs font-bold text-emerald-400 font-mono" dir="ltr">
          <span>0:00</span>
          <div class="relative flex-grow h-2 bg-white/10 rounded-full overflow-hidden cursor-pointer group"
            @click="seek($event)">
            <div
              class="absolute inset-y-0 left-0 bg-emerald-500 w-0 transition-all duration-100 group-hover:bg-emerald-400"
              :style="`width: ${progress}%`"></div>
          </div>
          <span
            x-text="duration ? (Math.floor(duration / 60) + ':' + ('0' + Math.floor(duration % 60)).slice(-2)) : '0:00'"></span>
        </div>

        <div class="flex items-center justify-center gap-6">
          <!-- Slow Motion Playback -->
          <div class="flex items-center gap-2">
            <button @click="setSpeed(0.5)"
              :class="speed === 0.5 ? 'bg-emerald-500 text-slate-950' : 'bg-white/5 text-slate-400 hover:bg-white/10'"
              class="w-10 h-10 rounded-xl font-bold text-xs transition-all">0.5x</button>
            <button @click="setSpeed(0.75)"
              :class="speed === 0.75 ? 'bg-emerald-500 text-slate-950' : 'bg-white/5 text-slate-400 hover:bg-white/10'"
              class="w-10 h-10 rounded-xl font-bold text-xs transition-all">0.75x</button>
            <button @click="setSpeed(1.0)"
              :class="speed === 1.0 ? 'bg-emerald-500 text-slate-950' : 'bg-white/5 text-slate-400 hover:bg-white/10'"
              class="w-10 h-10 rounded-xl font-bold text-xs transition-all">1x</button>
            <button @click="setSpeed(1.25)"
              :class="speed === 1.25 ? 'bg-emerald-500 text-slate-950' : 'bg-white/5 text-slate-400 hover:bg-white/10'"
              class="w-10 h-10 rounded-xl font-bold text-xs transition-all">1.25x</button>
          </div>

          <!-- Main Play Action -->
          <button @click="toggle()"
            class="group relative w-20 h-20 flex items-center justify-center rounded-full bg-white text-slate-950 shadow-2xl hover:scale-110 active:scale-95 transition-all outline-none border-0 ring-4 ring-white/10">
            <i :class="audioPlaying ? 'fas fa-pause text-xl' : 'fas fa-play text-xl ml-1'"
              class="relative z-10 transition-all"></i>
          </button>

          <!-- Repeat Toggle -->
          <button @click="repeat = !repeat"
            :class="repeat ? 'text-emerald-400 bg-emerald-500/20' : 'text-slate-500 hover:text-white bg-white/5'"
            class="w-12 h-12 rounded-2xl flex items-center justify-center transition-all">
            <i class="fas fa-repeat"></i>
          </button>
        </div>

        <div class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">
          Space to Play/Pause
        </div>
      </div>
    </div>
  </section>
  {% endif %}

  <div class="grid lg:grid-cols-12 gap-8">
    <!-- LEFT: Makhraj & Shapes -->
    <div class="lg:col-span-8 space-y-8">
      <!-- MAKHRAJ -->
      {% if letter.makhraj_description or letter.makhraj_image %}
      <section class="rounded-[2.5rem] border border-white/10 bg-slate-900/40 p-8">
        <div class="flex flex-col md:flex-row gap-8 items-center">
          {% if letter.makhraj_image %}
          <div class="w-full md:w-1/3">
            <img src="{{ letter.makhraj_image.url }}" alt="Maxraj"
              class="w-full rounded-2xl border border-white/10 shadow-xl">
          </div>
          {% endif %}
          <div class="flex-1 space-y-4">
            <h2 class="text-2xl font-black text-white tracking-tight uppercase flex items-center gap-3">
              <span class="w-2 h-6 bg-emerald-500 rounded-full"></span>
              Maxraj
            </h2>
            {% if letter.makhraj_description %}
            <p class="text-slate-300 text-lg leading-relaxed">
              {{ letter.makhraj_description|linebreaksbr }}
            </p>
            {% endif %}
          </div>
        </div>
      </section>
      {% endif %}

      {% if letter.initial or letter.medial or letter.final or letter.isolated %}
      <!-- SHAPES -->
      <section class="rounded-[2.5rem] border border-white/10 bg-slate-900/40 p-8">
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-2xl font-black text-white tracking-tight uppercase flex items-center gap-3">
            <span class="w-2 h-6 bg-sky-500 rounded-full"></span>
            YOZILISH SHAKLLARI
          </h2>
          <div
            class="px-3 py-1 rounded-full text-[10px] font-bold border border-current {{ letter.joins_to_next|yesno:'bg-emerald-500/20 text-emerald-400,bg-red-500/20 text-red-400' }}">
            <span>{{ letter.joins_to_next|yesno:"Qo'shiladi,Qo'shilmaydi" }}</span>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" dir="rtl">
          <!-- Always show isolated as fallback if others missing -->
          <div @click="activeForm = 'isolated'"
            :class="activeForm === 'isolated' ? 'bg-white border-white scale-105 z-10' : 'bg-white/5 border-white/10'"
            class="group p-8 rounded-3xl border transition-all cursor-pointer text-center shadow-lg">
            <div :class="activeForm === 'isolated' ? 'text-slate-950' : 'text-slate-500'"
              class="text-[10px] font-black uppercase mb-3 [direction:ltr]">ALOHIDA</div>
            <div :class="activeForm === 'isolated' ? 'text-slate-950' : 'text-white'"
              class="arabic-font text-6xl group-hover:scale-110 transition-transform">
              {% if letter.isolated %}{{ letter.isolated }}{% else %}{{ letter.arabic }}{% endif %}
            </div>
          </div>
          {% if letter.initial %}
          <div @click="activeForm = 'initial'"
            :class="activeForm === 'initial' ? 'bg-white border-white scale-105 z-10' : 'bg-white/5 border-white/10'"
            class="group p-8 rounded-3xl border transition-all cursor-pointer text-center shadow-lg">
            <div :class="activeForm === 'initial' ? 'text-slate-950' : 'text-slate-500'"
              class="text-[10px] font-black uppercase mb-3 [direction:ltr]">BOSHIDA</div>
            <div :class="activeForm === 'initial' ? 'text-slate-950' : 'text-white'"
              class="arabic-font text-6xl group-hover:scale-110 transition-transform">
              {{ letter.initial }}
            </div>
          </div>
          {% endif %}
          {% if letter.medial %}
          <div @click="activeForm = 'medial'"
            :class="activeForm === 'medial' ? 'bg-white border-white scale-105 z-10' : 'bg-white/5 border-white/10'"
            class="group p-8 rounded-3xl border transition-all cursor-pointer text-center shadow-lg">
            <div :class="activeForm === 'medial' ? 'text-slate-950' : 'text-slate-500'"
              class="text-[10px] font-black uppercase mb-3 [direction:ltr]">O'RTASIDA</div>
            <div :class="activeForm === 'medial' ? 'text-slate-950' : 'text-white'"
              class="arabic-font text-6xl group-hover:scale-110 transition-transform">
              {{ letter.medial }}
            </div>
          </div>
          {% endif %}
          {% if letter.final %}
          <div @click="activeForm = 'final'"
            :class="activeForm === 'final' ? 'bg-white border-white scale-105 z-10' : 'bg-white/5 border-white/10'"
            class="group p-8 rounded-3xl border transition-all cursor-pointer text-center shadow-lg">
            <div :class="activeForm === 'final' ? 'text-slate-950' : 'text-slate-500'"
              class="text-[10px] font-black uppercase mb-3 [direction:ltr]">OXIRIDA</div>
            <div :class="activeForm === 'final' ? 'text-slate-950' : 'text-white'"
              class="arabic-font text-6xl group-hover:scale-110 transition-transform">
              {{ letter.final }}
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Tips section removed for puristic data-driven UI -->
      </section>
      {% endif %}
    </div>

    <!-- RIGHT: Examples -->
    <div class="lg:col-span-4 space-y-8">
      <!-- EXAMPLES -->
      <section class="rounded-[2.5rem] border border-white/10 bg-slate-900/40 p-6 md:p-8 space-y-8">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-2xl bg-emerald-500/10 flex items-center justify-center text-emerald-400">
            <i class="fas fa-book-open text-xl"></i>
          </div>
          <div>
            <h3 class="text-white font-black text-lg uppercase tracking-tight">Misollar</h3>
            <p class="text-xs text-slate-500 uppercase tracking-widest mt-0.5">So'zlardagi qo'llanilishi</p>
          </div>
        </div>

        <div class="space-y-4">
          {% for ex in examples %}
          <div @click="playAudio('{{ ex.audio.url|default:'' }}')"
            class="group relative flex items-center justify-between p-5 rounded-3xl bg-white/5 border border-white/5 hover:border-emerald-500/30 hover:bg-emerald-500/5 transition-all cursor-pointer shadow-sm overflow-hidden">

            <div
              class="absolute inset-y-0 left-0 w-1 bg-emerald-500 opacity-0 group-hover:opacity-100 transition-opacity">
            </div>

            <div class="flex items-center gap-4">
              <div
                class="w-12 h-12 rounded-2xl bg-slate-950 border border-white/5 flex items-center justify-center text-slate-500 group-hover:text-emerald-400 group-hover:scale-110 transition-all duration-300">
                <i class="fas fa-play text-xs" :class="playing ? 'animate-pulse' : ''"></i>
              </div>
              <div>
                <div class="text-white font-black text-base group-hover:text-emerald-400 transition-colors">{{
                  ex.translation_uz }}</div>
                <div class="text-[10px] text-slate-500 uppercase tracking-[0.2em] mt-0.5 font-bold">{{
                  ex.transliteration }}</div>
              </div>
            </div>

            <div
              class="arabic-font text-4xl text-white group-hover:text-emerald-400 group-hover:scale-105 transition-all duration-300"
              dir="rtl">
              {{ ex.arabic_text }}
            </div>
          </div>
          {% empty %}
          <div class="py-12 text-center">
            <div class="text-4xl mb-4 opacity-20">üìö</div>
            <p class="text-slate-500 text-xs uppercase tracking-[0.2em]">Hozircha misollar yo'q</p>
          </div>
          {% endfor %}
        </div>
      </section>

      <!-- HARAKATS -->
      <section class="rounded-[2.5rem] border border-white/10 bg-slate-900/40 p-6">
        <h3 class="text-white font-black text-sm uppercase tracking-widest mb-6 text-center">Unli harakatlar</h3>
        <div class="grid grid-cols-3 gap-3" dir="rtl">
          <div class="p-4 rounded-2xl bg-white/5 border border-white/10 text-center transition hover:bg-white/10">
            <div class="arabic-font text-4xl text-emerald-400 mb-1">{{ letter.arabic }}Ÿé</div>
            <div class="text-[9px] text-slate-500 [direction:ltr]">Fatha</div>
          </div>
          <div class="p-4 rounded-2xl bg-white/5 border border-white/10 text-center transition hover:bg-white/10">
            <div class="arabic-font text-4xl text-sky-400 mb-1">{{ letter.arabic }}Ÿê</div>
            <div class="text-[9px] text-slate-500 [direction:ltr]">Kasra</div>
          </div>
          <div class="p-4 rounded-2xl bg-white/5 border border-white/10 text-center transition hover:bg-white/10">
            <div class="arabic-font text-4xl text-amber-400 mb-1">{{ letter.arabic }}Ÿè</div>
            <div class="text-[9px] text-slate-500 [direction:ltr]">Damma</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <style>
    .arabic-font {
      font-family: 'Noto Naskh Arabic', serif;
    }
  </style>
  {% endblock %}