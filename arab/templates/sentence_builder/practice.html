{% extends "base.html" %}
{% block title %}Gap Tuzish Mashqi | AlifPro{% endblock %}
{% block content %}

<div class="max-w-3xl mx-auto py-12 px-4">
    <!-- Header -->
    <div class="text-center mb-10">
        <div
            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-orange-500/10 border border-orange-500/20 text-[10px] font-black uppercase tracking-widest text-orange-400 mb-4">
            GAP TUZISH
        </div>
        <h1 class="text-3xl font-black text-white">So'zlarni Tartibga Qo'ying</h1>
    </div>

    <!-- Quiz Card -->
    <div class="p-8 rounded-[3rem] bg-slate-900/60 border border-white/10" id="quizCard">
        <!-- Uzbek Sentence -->
        <div class="text-center mb-8">
            <div class="text-sm text-slate-400 mb-2">Tarjima qiling:</div>
            <div class="text-xl text-white">{{ exercise.uzbek_sentence }}</div>
        </div>

        {% if exercise.hint %}
        <div class="text-center text-sm text-amber-400 mb-6">
            <i class="fas fa-lightbulb mr-1"></i>{{ exercise.hint }}
        </div>
        {% endif %}

        <!-- Word Bank -->
        <div class="mb-6">
            <div class="text-xs text-slate-400 mb-3 text-center">So'zlarni bosing:</div>
            <div id="wordBank" class="flex flex-wrap justify-center gap-3">
                {% for word in words %}
                <button type="button" onclick="addWord(this, '{{ word }}')"
                    class="word-btn px-4 py-3 rounded-xl bg-slate-800 border border-white/10 text-xl font-arabic text-white hover:border-orange-500/50 hover:bg-slate-700 transition-all">
                    {{ word }}
                </button>
                {% endfor %}
            </div>
        </div>

        <!-- Answer Zone -->
        <div class="mb-6">
            <div class="text-xs text-slate-400 mb-3 text-center">Sizning javobingiz:</div>
            <div id="answerZone"
                class="min-h-[80px] p-4 rounded-2xl bg-slate-800/50 border-2 border-dashed border-white/20 flex flex-wrap justify-center gap-3"
                dir="rtl">
                <!-- Words will be added here -->
            </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-4 justify-center mb-6">
            <button type="button" onclick="clearAnswer()"
                class="px-6 py-3 rounded-xl bg-slate-700 text-white hover:bg-slate-600 transition-all">
                <i class="fas fa-undo mr-2"></i>Tozalash
            </button>
            <button type="button" onclick="checkSentence()"
                class="px-8 py-3 rounded-xl bg-orange-500 text-slate-900 font-bold hover:bg-orange-400 transition-all">
                <i class="fas fa-check mr-2"></i>Tekshirish
            </button>
        </div>

        <!-- Result -->
        <div id="resultArea" class="hidden mt-6 p-6 rounded-2xl text-center">
            <div id="resultIcon" class="text-6xl mb-4"></div>
            <div id="resultText" class="text-2xl font-bold mb-2"></div>
            <div id="correctAnswer" class="hidden text-xl font-arabic text-emerald-400 mb-4"></div>
            {% if exercise.explanation %}
            <div class="text-slate-400 text-sm mb-4">{{ exercise.explanation }}</div>
            {% endif %}
            <a href="{% url 'arab:sentence_builder_practice' %}"
                class="inline-block px-6 py-3 rounded-xl bg-orange-500 text-slate-900 font-bold hover:bg-orange-400 transition-all">
                Keyingi <i class="fas fa-arrow-right ml-2"></i>
            </a>
        </div>
    </div>

    <!-- Back Link -->
    <div class="mt-8 text-center">
        <a href="{% url 'arab:sentence_builder_index' %}"
            class="text-slate-400 hover:text-orange-400 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Mashqlarga qaytish
        </a>
    </div>
</div>

<script>
    let selectedWords = [];
    const correctSentence = "{{ correct_sentence }}";
    const exerciseId = {{ exercise.id }};

    function addWord(btn, word) {
        btn.classList.add('opacity-30');
        btn.disabled = true;
        selectedWords.push(word);
        renderAnswer();
    }

    function removeWord(index) {
        const word = selectedWords[index];
        selectedWords.splice(index, 1);

        // Re-enable the word in bank
        document.querySelectorAll('.word-btn').forEach(btn => {
            if (btn.textContent.trim() === word && btn.disabled) {
                btn.classList.remove('opacity-30');
                btn.disabled = false;
            }
        });

        renderAnswer();
    }

    function renderAnswer() {
        const zone = document.getElementById('answerZone');
        zone.innerHTML = selectedWords.map((word, i) =>
            `<button onclick="removeWord(${i})" class="px-4 py-3 rounded-xl bg-orange-500/20 border border-orange-500/50 text-xl font-arabic text-orange-400 hover:bg-orange-500/30 transition-all">
            ${word} <i class="fas fa-times text-xs ml-2 opacity-50"></i>
        </button>`
        ).join('');
    }

    function clearAnswer() {
        selectedWords = [];
        document.querySelectorAll('.word-btn').forEach(btn => {
            btn.classList.remove('opacity-30');
            btn.disabled = false;
        });
        renderAnswer();
    }

    function checkSentence() {
        const userSentence = selectedWords.join(' ');
        const resultArea = document.getElementById('resultArea');
        const resultIcon = document.getElementById('resultIcon');
        const resultText = document.getElementById('resultText');
        const correctEl = document.getElementById('correctAnswer');

        const isCorrect = userSentence === correctSentence;

        resultArea.classList.remove('hidden');

        if (isCorrect) {
            resultArea.classList.add('bg-emerald-500/20');
            resultArea.classList.remove('bg-rose-500/20');
            resultIcon.textContent = 'üéâ';
            resultText.textContent = "To'g'ri! +15 XP";
            resultText.className = 'text-2xl font-bold mb-2 text-emerald-400';
        } else {
            resultArea.classList.add('bg-rose-500/20');
            resultArea.classList.remove('bg-emerald-500/20');
            resultIcon.textContent = '‚ùå';
            resultText.textContent = "Noto'g'ri";
            resultText.className = 'text-2xl font-bold mb-2 text-rose-400';
            correctEl.classList.remove('hidden');
            correctEl.textContent = "To'g'ri javob: " + correctSentence;
        }

        // Send to API
        fetch('{% url "arab:api_sentence_check" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                exercise_id: exerciseId,
                sentence: userSentence
            })
        });
    }
</script>

{% endblock %}