{% extends "base.html" %}
{% block title %}{{ video.title }} - Video{% endblock %}
{% block content %}

<!-- HEADER -->
<div class="mb-6">
    <a href="{% url 'arab:lesson_detail' video.lesson.id %}"
        class="inline-flex items-center gap-2 text-sm text-slate-400 hover:text-white transition mb-4">
        ‚Üê Darsga qaytish
    </a>
    <h1 class="text-2xl md:text-3xl font-black text-white">{{ video.title }}</h1>
    <div class="mt-2 flex items-center gap-3 text-sm text-slate-400">
        <span>‚è± {{ video.duration }} soniya</span>
        {% if progress.is_watched %}
        <span class="text-emerald-400 font-semibold">‚úÖ Ko‚Äòrilgan</span>
        {% else %}
        <span class="text-amber-400">üïí Jarayonda</span>
        {% endif %}
    </div>
</div>

<!-- PLAYER CONTAINER -->
<div class="relative w-full aspect-video rounded-3xl overflow-hidden border border-white/10 bg-black shadow-2xl">
    {% if video.is_youtube %}
    <div id="player" class="absolute inset-0 w-full h-full"></div>
    {% elif video.provider == 'url' %}
    <video id="video-player" class="w-full h-full" controls preload="metadata">
        <source src="{{ video.get_url }}">
        Browser videoni qo'llab-quvvatlamaydi.
    </video>
    {% else %}
    <div class="flex items-center justify-center h-full text-slate-400">
        <div class="text-center">
            <div class="text-4xl mb-2">‚ö†Ô∏è</div>
            <div>Provider noto'g'ri: {{ video.provider }}</div>
        </div>
    </div>
    {% endif %}
</div>

<!-- DEBUG INFO -->
<div class="mt-2 p-3 rounded-xl bg-slate-900/50 text-xs text-slate-400">
    <div><strong>Provider:</strong> {{ video.provider }}</div>
    <div><strong>Video ID:</strong> {{ video.video_id|default:"(yo'q)" }}</div>
    <div><strong>Video URL:</strong> {{ video.video_url|default:"(yo'q)" }}</div>
    <div><strong>Get URL:</strong> {{ video.get_url|default:"(yo'q)" }}</div>
</div>

<!-- PROGRESS BAR -->
<div class="mt-6 rounded-2xl border border-white/10 bg-white/5 p-6">
    <div class="flex items-center justify-between text-sm mb-2">
        <span class="text-slate-300">Progress</span>
        <span class="text-emerald-400 font-bold" id="status-text">
            {% if progress.is_watched %}Tabriklaymiz! +20 XP{% else %}Ko‚Äòrishda davom eting{% endif %}
        </span>
    </div>
    <div class="h-2 w-full bg-white/10 rounded-full overflow-hidden">
        <div id="progress-bar" class="h-full bg-emerald-500 transition-all duration-300" style="width: 0%"></div>
    </div>
    <p class="mt-4 text-xs text-slate-400">
        Videoning 80% qismini ko‚Äòrsangiz, dars "o‚Äòzlashtirildi" deb hisoblanadi va XP beriladi.
    </p>
</div>

{% csrf_token %}

<script>
    let videoId = "{{ video.id }}";
    let duration = {{ video.duration }};
    let isWatched = {{ progress.is_watched| lower }};
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let timer = null;

    function updateProgress(seconds) {
        if (isWatched || !duration) return;

        // UI Update
        let pct = Math.min(100, (seconds / duration) * 100);
        if (isNaN(pct)) pct = 0;
        document.getElementById('progress-bar').style.width = pct + "%";

        // Server check every 5 sec or if significant change
        // For simplicity, we assume robust logic server-side too
        if (pct >= 80) {
            document.getElementById('status-text').innerText = "Tabriklaymiz! +20 XP";
            document.getElementById('progress-bar').classList.add('bg-emerald-400');
        }

        // Send AJAX
        // Throttle: only send every 5 sec
        fetch("{% url 'arab:video_progress' video.id %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrfToken,
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "seconds=" + Math.floor(seconds)
        })
            .then(r => r.json())
            .then(data => {
                if (data.watched) isWatched = true;
            });
    }

    {% if video.is_youtube %}
    // YouTube IFrame API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var player;
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            videoId: '{{ video.get_youtube_id }}',
            events: {
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            startTimer();
        } else {
            stopTimer();
        }
    }

    function startTimer() {
        if (timer) clearInterval(timer);
        timer = setInterval(() => {
            let time = player.getCurrentTime();
            updateProgress(time);
        }, 5000);
    }
    function stopTimer() {
        if (timer) clearInterval(timer);
    }

    {% else %}
    // HTML5 Video
    const v = document.getElementById('video-player');
    if (v) {
        v.ontimeupdate = () => {
            if (Math.floor(v.currentTime) % 5 === 0) {
                updateProgress(v.currentTime);
            }
        };
    }
    {% endif %}

</script>

{% endblock %}