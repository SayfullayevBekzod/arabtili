{% extends "base.html" %}
{% block title %}{{ video.title }} - Video{% endblock %}
{% block content %}

<!-- HEADER -->
<div class="mb-8 relative z-10">
    <a href="{% url 'arab:lesson_detail' video.lesson.id %}"
        class="inline-flex items-center gap-2 text-[10px] font-black text-slate-500 hover:text-white uppercase tracking-widest bg-white/5 px-4 py-2 rounded-xl border border-white/5 transition mb-6">
        <i class="fas fa-arrow-left text-[8px]"></i> Darsga qaytish
    </a>
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-6">
        <div class="space-y-2">
            <h1 class="text-4xl md:text-5xl font-black text-white leading-tight tracking-tight">{{ video.title }}</h1>
            <div class="flex items-center gap-4 text-xs font-medium text-slate-400">
                <span class="flex items-center gap-2"><i class="far fa-clock text-sky-400"></i> {{ video.duration }}
                    soniya</span>
                <span class="h-1 w-1 rounded-full bg-slate-700"></span>
                {% if progress.is_watched %}
                <span
                    class="text-emerald-400 font-black uppercase tracking-widest bg-emerald-500/10 px-3 py-1 rounded-lg border border-emerald-500/20 flex items-center gap-2">
                    <i class="fas fa-check-circle"></i> Ko‘rilgan
                </span>
                {% else %}
                <span
                    class="text-amber-400 font-black uppercase tracking-widest bg-amber-500/10 px-3 py-1 rounded-lg border border-amber-500/20 flex items-center gap-2">
                    <i class="fas fa-spinner fa-spin"></i> Jarayonda
                </span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- PLAYER CONTAINER -->
<div
    class="relative w-full aspect-video rounded-[3rem] overflow-hidden border border-white/10 bg-black shadow-[0_30px_60px_-15px_rgba(0,0,0,0.6)] group">
    <div
        class="absolute inset-0 bg-gradient-to-br from-emerald-500/5 to-sky-500/5 pointer-events-none transition-opacity group-hover:opacity-0">
    </div>

    {% if video.is_youtube %}
    <div id="player" class="absolute inset-0 w-full h-full"></div>
    {% elif video.provider == 'url' %}
    <video id="video-player" class="w-full h-full" controls preload="metadata">
        <source src="{{ video.get_url }}">
        Browser videoni qo'llab-quvvatlamaydi.
    </video>
    {% else %}
    <div class="flex items-center justify-center h-full text-slate-500 bg-slate-900">
        <div class="text-center space-y-4">
            <div class="text-6xl animate-pulse">⚠️</div>
            <div class="font-black uppercase tracking-widest text-[10px]">Provider noto'g'ri: {{ video.provider }}</div>
        </div>
    </div>
    {% endif %}
</div>

<!-- PROGRESS MONITOR -->
<div class="mt-10 p-1 rounded-[2.5rem] bg-gradient-to-r from-white/5 to-white/0">
    <div class="rounded-[2.4rem] bg-slate-900/60 backdrop-blur-xl p-8 border border-white/5">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-6 mb-6">
            <div class="flex items-center gap-4">
                <div
                    class="h-12 w-12 rounded-2xl bg-emerald-500/10 flex items-center justify-center text-emerald-400 text-xl border border-emerald-500/20">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div>
                    <h4 class="text-white font-black uppercase tracking-tight text-sm">O'zlashtirish Progressi</h4>
                    <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest mt-1">Kamida 80%
                        ko'rishingiz kerak</p>
                </div>
            </div>
            <span
                class="text-emerald-400 font-black uppercase tracking-widest text-xs bg-emerald-500/10 px-4 py-2 rounded-xl border border-emerald-500/20"
                id="status-text">
                {% if progress.is_watched %}TAMOMLANDI +20 XP{% else %}DAVOM ETING{% endif %}
            </span>
        </div>

        <div class="h-4 w-full bg-slate-950 rounded-full overflow-hidden border border-white/5 p-0.5 shadow-inner">
            <div id="progress-bar"
                class="h-full bg-gradient-to-r from-emerald-500 via-sky-500 to-emerald-500 rounded-full transition-all duration-700 shadow-[0_0_15px_rgba(16,185,129,0.3)]"
                style="width: 0%"></div>
        </div>
    </div>
</div>

<!-- NOTES & ACTIONS -->
<div class="mt-10 grid lg:grid-cols-2 gap-10">

    <!-- NOTES -->
    <div x-data="{ note: localStorage.getItem('note_video_{{ video.id }}') || '' }" class="space-y-4">
        <div class="flex items-center gap-3 ml-2">
            <i class="fas fa-edit text-slate-500"></i>
            <label class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Shaxsiy qaydlarim</label>
        </div>
        <textarea x-model="note" @input="localStorage.setItem('note_video_{{ video.id }}', note)"
            class="w-full bg-slate-900/40 backdrop-blur-md border border-white/10 rounded-[2rem] p-8 text-white placeholder-slate-700 focus:outline-none focus:border-emerald-500/30 focus:ring-[15px] focus:ring-emerald-500/5 transition-all h-48 block text-lg font-medium leading-relaxed"
            placeholder="Shu darsdagi muhim joylarni yozib oling..."></textarea>
    </div>

    <!-- NEXT UP -->
    <div class="space-y-6">
        {% if next_video %}
        <div class="flex items-center gap-3 ml-2">
            <i class="fas fa-forward text-slate-500"></i>
            <label class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Keyingi Dars</label>
        </div>
        <a href="{% url 'arab:video_detail' next_video.id %}"
            class="group relative block overflow-hidden rounded-[2.5rem] border border-white/10 bg-slate-900/40 backdrop-blur-md p-8 hover:bg-slate-900/60 transition-all duration-500 shadow-2xl">
            <div
                class="absolute -top-24 -right-24 h-48 w-48 bg-emerald-500/0 group-hover:bg-emerald-500/5 rounded-full blur-3xl transition-all duration-700">
            </div>

            <div class="relative z-10 flex items-center gap-6">
                <div
                    class="h-16 w-16 rounded-2xl bg-white text-slate-950 flex items-center justify-center text-xl shadow-xl group-hover:scale-110 transition-transform">
                    <i class="fas fa-play ml-1"></i>
                </div>
                <div class="flex-1">
                    <h3
                        class="text-xl font-black text-white group-hover:text-emerald-400 transition leading-tight tracking-tight">
                        {{ next_video.title }}</h3>
                    <div
                        class="mt-2 text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2">
                        <span>DAVOM ETISH</span>
                        <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>
            </div>
        </a>
        {% endif %}

        {% if related_videos %}
        <div class="space-y-4">
            <div class="flex items-center gap-3 ml-2 pt-4">
                <i class="fas fa-th-list text-slate-500"></i>
                <label class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">O'xshash
                    videolar</label>
            </div>
            <div class="grid gap-3">
                {% for rv in related_videos %}
                <a href="{% url 'arab:video_detail' rv.id %}"
                    class="flex items-center gap-5 p-4 rounded-[1.5rem] border border-white/5 bg-white/[0.02] hover:bg-white/5 transition-all group">
                    <div
                        class="h-12 w-12 rounded-xl bg-slate-950 border border-white/10 flex items-center justify-center text-slate-600 group-hover:text-emerald-400 transition-all shrink-0 shadow-inner">
                        <i class="fas fa-play text-[10px]"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div
                            class="text-sm font-black text-white group-hover:text-emerald-400 transition truncate tracking-tight">
                            {{ rv.title }}</div>
                        <div class="text-[10px] font-black text-slate-500 uppercase tracking-widest mt-1">{{ rv.duration
                            }} sek</div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% csrf_token %}

<script>
    let videoId = "{{ video.id }}";
    let duration = {{ video.duration }};
    let isWatched = {{ progress.is_watched| lower }};
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let timer = null;

    function updateProgress(seconds) {
        if (isWatched || !duration) return;

        // UI Update
        let pct = Math.min(100, (seconds / duration) * 100);
        if (isNaN(pct)) pct = 0;
        document.getElementById('progress-bar').style.width = pct + "%";

        // Server check every 5 sec or if significant change
        // For simplicity, we assume robust logic server-side too
        if (pct >= 80) {
            document.getElementById('status-text').innerText = "Tabriklaymiz! +20 XP";
            document.getElementById('progress-bar').classList.add('bg-emerald-400');
        }

        // Send AJAX
        // Throttle: only send every 5 sec
        fetch("{% url 'arab:video_progress' video.id %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrfToken,
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "seconds=" + Math.floor(seconds)
        })
            .then(r => r.json())
            .then(data => {
                if (data.watched) isWatched = true;
            });
    }

    {% if video.is_youtube %}
    // YouTube IFrame API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var player;
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            videoId: '{{ video.get_youtube_id }}',
            events: {
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            startTimer();
        } else {
            stopTimer();
        }
    }

    function startTimer() {
        if (timer) clearInterval(timer);
        timer = setInterval(() => {
            let time = player.getCurrentTime();
            updateProgress(time);
        }, 5000);
    }
    function stopTimer() {
        if (timer) clearInterval(timer);
    }

    {% else %}
    // HTML5 Video
    const v = document.getElementById('video-player');
    if (v) {
        v.ontimeupdate = () => {
            if (Math.floor(v.currentTime) % 5 === 0) {
                updateProgress(v.currentTime);
            }
        };
    }
    {% endif %}

</script>

{% endblock %}