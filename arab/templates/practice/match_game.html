{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-slate-900 py-8 px-4 font-inter text-slate-100 relative overflow-hidden">
    <!-- Background Decor -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-emerald-500/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-sky-500/10 rounded-full blur-[120px]"></div>
    </div>

    <div class="relative z-10 max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <h1
                class="text-3xl font-black bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-sky-400 uppercase tracking-tight">
                Juftlikni Toping
            </h1>
            <div class="flex items-center gap-4">
                <div class="px-4 py-2 rounded-xl bg-white/5 border border-white/10 font-mono text-emerald-400 font-bold shadow-lg"
                    id="timer">
                    00:00
                </div>
                <div class="px-4 py-2 rounded-xl bg-white/5 border border-white/10 text-amber-400 font-bold shadow-lg flex items-center gap-2"
                    id="score">
                    <i class="fas fa-bolt text-xs"></i> 0 XP
                </div>
            </div>
        </div>

        <!-- Game Board -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="game-board">
            <!-- Cards injected by JS -->
        </div>

        <!-- Win Overlay (Hidden) -->
        <div id="win-overlay"
            class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/90 backdrop-blur-xl transition-all duration-500">
            <div
                class="bg-slate-800/80 border border-white/10 rounded-[2rem] p-10 max-w-sm w-full text-center shadow-2xl shadow-emerald-500/10 transform scale-100 transition-all">
                <div
                    class="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl animate-bounce">
                    üèÜ
                </div>
                <h2 class="text-3xl font-black text-white mb-2 tracking-tight">AJOYIB!</h2>
                <p class="text-slate-400 mb-8 font-medium">Siz barcha juftliklarni <span id="final-time"
                        class="text-emerald-400 font-bold font-mono"></span> ichida topdingiz!</p>
                <div class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-tr from-amber-400 to-orange-400 mb-8 drop-shadow-sm"
                    id="xp-gain">+60 XP</div>
                <button onclick="location.reload()"
                    class="w-full py-4 rounded-2xl bg-white text-slate-950 font-black text-sm tracking-widest hover:bg-slate-200 transition-all shadow-xl active:scale-95 uppercase">
                    Qayta O'ynash
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const rawData = JSON.parse('{{ game_data|escapejs }}');
    const board = document.getElementById('game-board');
    let cards = [];
    let selectedFirst = null;
    let lockBoard = false;
    let matchesFound = 0;
    let timerInterval;
    let startTime;
    let totalXP = 0;

    function initGame() {
        if (!rawData || !rawData.length) {
            board.innerHTML = '<div class="col-span-full text-center text-slate-500">Hozircha ma\'lumot yo\'q.</div>';
            return;
        }

        // Prepare pairs: (id, text, type)
        let pairs = [];
        rawData.forEach(item => {
            pairs.push({ id: item.id, text: item.arabic, type: 'arabic' });
            pairs.push({ id: item.id, text: item.translation, type: 'translation' });
        });

        // Shuffle
        pairs.sort(() => Math.random() - 0.5);

        // Render
        board.innerHTML = '';
        pairs.forEach(p => {
            const card = document.createElement('div');
            card.className = `
                relative h-28 md:h-36 cursor-pointer 
                bg-white/5 border border-white/10 rounded-3xl 
                flex items-center justify-center text-center p-4
                transition-all duration-300 hover:bg-white/10 hover:border-white/20 hover:scale-[1.02] hover:shadow-xl
                select-none active:scale-95 group
            `;
            if (p.type === 'arabic') {
                card.classList.add('arabic-font', 'text-4xl', 'md:text-5xl', 'text-white', 'font-black');
            } else {
                card.classList.add('font-bold', 'text-sm', 'md:text-base', 'text-slate-300', 'uppercase', 'tracking-wide');
            }

            // Create inner content wrapper for better centering
            const inner = document.createElement('div');
            inner.className = "pointer-events-none group-hover:scale-110 transition-transform duration-300";
            inner.innerText = p.text;
            card.appendChild(inner);

            card.dataset.id = p.id;
            card.onclick = () => handleCardClick(card);
            board.appendChild(card);
        });

        startTimer();
    }

    function handleCardClick(card) {
        if (lockBoard || card === selectedFirst || card.classList.contains('opacity-0')) return;

        // Active State
        card.classList.add('!border-emerald-500', '!bg-emerald-500/20', '!text-emerald-400');
        if (card.querySelector('.text-slate-300')) {
            card.querySelector('.text-slate-300').classList.remove('text-slate-300');
            card.querySelector('.font-bold').classList.add('text-emerald-400');
        }

        if (!selectedFirst) {
            selectedFirst = card;
        } else {
            checkForMatch(selectedFirst, card);
        }
    }

    function checkForMatch(card1, card2) {
        lockBoard = true;
        const isMatch = card1.dataset.id === card2.dataset.id;

        if (isMatch) {
            disableCards(card1, card2);
        } else {
            unflipCards(card1, card2);
        }
    }

    function disableCards(card1, card2) {
        // Success animation
        card1.classList.add('!bg-emerald-500', '!text-slate-950', 'scale-105', 'shadow-emerald-500/50');
        card2.classList.add('!bg-emerald-500', '!text-slate-950', 'scale-105', 'shadow-emerald-500/50');

        // Remove text colors to inherit black from parent
        const t1 = card1.querySelector('.text-emerald-400');
        if (t1) t1.classList.remove('text-emerald-400');
        const t2 = card2.querySelector('.text-emerald-400');
        if (t2) t2.classList.remove('text-emerald-400');

        setTimeout(() => {
            card1.classList.add('opacity-0', 'pointer-events-none', 'scale-0');
            card2.classList.add('opacity-0', 'pointer-events-none', 'scale-0');
            resetBoard();
            matchesFound++;
            totalXP += 10;
            updateScore();

            if (matchesFound * 2 === rawData.length * 2) { // Logic check: rawData is items, pairs is x2
                if (matchesFound === rawData.length) endGame();
            }
        }, 500);
    }

    function unflipCards(card1, card2) {
        // Error State
        card1.classList.add('animate-shake', '!border-rose-500', '!bg-rose-500/10', '!text-rose-400');
        card2.classList.add('animate-shake', '!border-rose-500', '!bg-rose-500/10', '!text-rose-400');

        setTimeout(() => {
            // Reset styles
            card1.classList.remove('!border-emerald-500', '!bg-emerald-500/20', '!text-emerald-400', '!border-rose-500', '!bg-rose-500/10', 'animate-shake', '!text-rose-400');
            card2.classList.remove('!border-emerald-500', '!bg-emerald-500/20', '!text-emerald-400', '!border-rose-500', '!bg-rose-500/10', 'animate-shake', '!text-rose-400');

            // Revert text colors
            if (card1.querySelector('.font-bold')) card1.querySelector('.font-bold').classList.add('text-slate-300');
            if (card2.querySelector('.font-bold')) card2.querySelector('.font-bold').classList.add('text-slate-300');

            resetBoard();
        }, 800);
    }

    function resetBoard() {
        [selectedFirst, lockBoard] = [null, false];
    }

    function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
            const delta = Math.floor((Date.now() - startTime) / 1000);
            const m = String(Math.floor(delta / 60)).padStart(2, '0');
            const s = String(delta % 60).padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    function updateScore() {
        document.getElementById('score').innerHTML = `<i class="fas fa-bolt text-xs"></i> ${totalXP} XP`;
    }

    function endGame() {
        clearInterval(timerInterval);
        const timeStr = document.getElementById('timer').innerText;
        document.getElementById('final-time').innerText = timeStr;
        document.getElementById('xp-gain').innerText = `+${totalXP} XP`;
        document.getElementById('win-overlay').classList.remove('hidden');

        // Play Win Sound if available
        const winSound = new Audio('/static/sounds/success.mp3'); // Try to play if exists
        winSound.play().catch(e => { });

        // Send API request
        fetch("{% url 'arab:api_match_reward' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ matches: matchesFound })
        }).catch(err => console.error(err));
    }

    initGame();
</script>

<style>
    .arabic-font {
        font-family: 'Noto Naskh Arabic', serif;
    }

    @keyframes shake {

        0%,
        100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-5px);
        }

        75% {
            transform: translateX(5px);
        }
    }

    .animate-shake {
        animation: shake 0.3s ease-in-out;
    }
</style>
{% endblock %}